<!DOCTYPE HTML>
<html lang="pt-BR">

<head>
  <title>Controle Aviário</title>
  <meta charset="UTF-8">
  <style>
    html {
      font-family: Arial;
      display: inline-block;
      margin: 0px auto;
      text-align: center;
    }

    span {
      font-weight: bold;
    }

    button {
      border-radius: 8px;
    }

    table, td {
      margin: auto;
      border: 1px solid black;
      border-collapse: collapse;
    }

    a {
      color: black;
    }

    input {
      width: 20%;
      margin: 4px 0;
      box-sizing: border-box;
      border: 2px solid #ccc;
      -webkit-transition: 0.5s;
      transition: 0.5s;
      outline: none;
    }

    input:focus{
      border: 2px solid #555;
    }

    .divPrincipal {
      border: 2px solid black;
      height: 300px;
      width: 1000px;
      margin: auto;
    }

    .divSensor {
      box-sizing: border-box;
      float: left;
      width: 25%;
      height: 100.2%;
    }

    .divAtuador {
      box-sizing: border-box;

      float: left;
      width: 33.33333%;
      height: 100.2%;
    }

    .divOperacao {
      float: left;
      width: 100%;
      height: 50%;
    }




    #div_param_nebulizer {
      display: block;
    }

    #div_act_exchanger {
      display: none;
    }

    #div_sensor_temp {
      border-right: 1px solid black;
    }

    #div_sensor_umidity {
      border-right: 1px solid black;
      border-left: 1px solid black;
    }

    #div_sensor_nipple {
      border-right: 1px solid black;
      border-left: 1px solid black;
    }

    #div_sensor_box {
      border-left: 1px solid black;
    }

    #div_actuator_nebulizer {
      border-right: 1px solid black;
    }

    #div_actuator_exchanger {
      border-right: 1px solid black;
      border-left: 1px solid black;
    }

    #div_actuator_fan {
      border-left: 1px solid black;
    }

    


  </style>
</head>

<body>
  <h1>MONITORAMENTO E CONTROLE DO AMBIENTE AVIÁRIO</h1>
  <h2>Sensores    <img src="https://i.ibb.co/bFLxfbg/sensores.png" width="35" height="25"></h2> 
  <div class="divPrincipal">
    <div class="divSensor" id="div_sensor_temp">
      <h3>Temperatura ambiente</h3> <br> <span id="climate_temperature"> --- </span> <br> <br>
      <img src="https://i.ibb.co/F62Cdvf/temperatura-ambiente.png" width="210" height="170">
    </div>
    <div class="divSensor" id="div_sensor_umidity">
      <h3>Umidade relativa do ar</h3> <br> <span id="climate_humidity"> --- </span> <br> <br>
      <img src="https://i.ibb.co/brRzT46/umidade.png" width="150" height="170">
    </div>
    <div class="divSensor" id="div_sensor_nipple">
      <h3>Temperatura da água do bebedouro</h3> <span id="nipple_temperature"> --- </span><br> <br>
      <img src="https://i.ibb.co/1bLQnq1/temperatura-bebedouro.png" width="130" height="170">
    </div>
    <div class="divSensor" id="div_sensor_box">
      <h3>Temperatura da água da caixa</h3> <span id="box_temperature"> --- </span><br> <br>
      <img src="https://i.ibb.co/nRSqZgW/temperatura-caixa.png" width="200" height="170">
    </div>
  </div>
  <h2>Atuadores  <img src="https://i.ibb.co/xzX95vw/atuadores.png" width="25" height="30"></h2>
  <div class="divPrincipal">
    <div class="divAtuador" id="div_actuator_nebulizer">
      <h3>Nebulizador</h3>
      Status: <span id="status_nebulizer"> --- </span> <br>
      <b> Modo de Operação  <img src="https://i.ibb.co/3hS4Xv1/modo-operacao.png" width="18" height="18"> </b>
      <table>
        <thead>
          <tr>
            <td id="manual_nebulizer"> <a href='javascript:buttonSetOpModeNebulizer(1);'>Manual</a> </td>
            <td id="automatic_nebulizer"> <a href='javascript:buttonSetOpModeNebulizer(0);'>Automático</a> </td>
          </tr>
        </thead>
      </table>
      <hr>

      <div id="div_param_nebulizer" class="divOperacao">

        <b>Parâmetro de acionamento <img src="https://i.ibb.co/fdLtDWH/parametro.png" width="18" height="18"></b><br><br>
        Umidade máxima: <br>
        <input type="text" id="minUmidity" value=""> % 
        <button type="button" onclick="buttonSetParameter('nebulizer/umidity', 'minUmidity')">Reconfigurar</button> <br><br>
        Temperatura mínima: <br>
        <input type="text" id="maxTempNeb" value=""> °C 
        <button type="button" onclick="buttonSetParameter('nebulizer/temp', 'maxTempNeb')">Reconfigurar</button>
      </div>

      <div id="div_act_nebulizer" class="divOperacao">
        <br><b>Acionamento <img src="https://i.ibb.co/1dJJJDr/acionamento.png" width="18" height="18"></b><br><br>
        <button type="button" id="button_nebulizer" onclick="buttonSetNebulizer()">---</button>
      </div>


    </div>
    <div class="divAtuador" id="div_actuator_exchanger">
      <h3>Trocador de água</h3>
      Status: <span id="status_exchanger"> --- </span> <br>
      <b> Modo de Operação  <img src="https://i.ibb.co/3hS4Xv1/modo-operacao.png" width="18" height="18"> </b>
      <table>
        <thead>
          <tr>
            <td id="manual_exchanger"> <a href='javascript:buttonSetOpModeExchanger(1);'>Manual</a> </td>
            <td id="automatic_exchanger"> <a href='javascript:buttonSetOpModeExchanger(0);'>Automático</a> </td>
          </tr>
        </thead>
      </table>
      <hr>

      <div id="div_param_exchanger" class="divOperacao">

        <b>Parâmetro de acionamento <img src="https://i.ibb.co/fdLtDWH/parametro.png" width="18" height="18"></b><br><br>
        Variação mínima: <br>
        <input type="text" id="deltaTemperature" value=""> °C 
        <button type="button" onclick="buttonSetParameter('exchanger/deltatemp', 'deltaTemperature')">Reconfigurar</button> <br><br>
        Tempo mínimo para uma próxima troca: <br>
        <input type="text" id="timeNextExchange" value=""> horas 
        <button type="button" onclick="buttonSetParameter('exchanger/time', 'timeNextExchange')">Reconfigurar</button>
      </div>

      <div id="div_act_exchanger" class="divOperacao">
        <br>
        <b>Acionamento <img src="https://i.ibb.co/1dJJJDr/acionamento.png" width="18" height="18"></b><br><br>
        <button type="button" id="button_exchanger" onclick="buttonSetExchanger()">---</button>
      </div>
    </div>

    <div class="divAtuador" id="div_actuator_fan">
      <h3>Ventilador</h3>
      Status: <span id="status_fan">---</span> <br>
      <b> Modo de Operação  <img src="https://i.ibb.co/3hS4Xv1/modo-operacao.png" width="18" height="18"> </b>
      <table>
        <thead>
          <tr>
            <td id="manual_fan"> <a href='javascript:buttonSetOpModeFan(1);'>Manual</a> </td>
            <td id="automatico_fan"> <a href='javascript:buttonSetOpModeFan(0);'>Automático</a> </td>
          </tr>
        </thead>
      </table>
      <hr>

      <div id="div_param_fan" class="divOperacao">
        <b>Parâmetro de acionamento  <img src="https://i.ibb.co/fdLtDWH/parametro.png" width="18" height="18"></b><br><br><br>
        Temperatura mínima: <br>
        <input type="number" id="maxTempFan"> °C 
        <button onclick="buttonSetParameter('fan/temp', 'maxTempFan')">Reconfigurar</button>

      </div>
      <div id="div_act_fan" class="divOperacao">
        <br>
        <b>Acionamento <img src="https://i.ibb.co/1dJJJDr/acionamento.png" width="18" height="18"></b><br><br>
        <button type="button" id="button_fan" onclick="buttonSetFan()">---</button>
      </div>
    </div>
  </div>
</body>
<script>
  function buttonSetParameter(url, inputID) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/actuators/parameter/set/" + url, true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4) {
        if (this.status == 200) {
          alert("Parâmetro reconfigurado!");
        }
        if (this.status == 304) {
          alert("Erro em reconfigurar o parâmetro de acionamento do equipamento!");
        }
      }

    };
    xhttp.send("value=" + document.getElementById(inputID).value);
  }

  


  function setOperationMode(mode, actuator_name) {
    // true = modo manual | false = modo automático
    if (mode == true) {
      document.getElementById("manual_" + actuator_name).style.fontWeight = 700;
      document.getElementById("automatic_" + actuator_name).style.fontWeight = 400;

      document.getElementById("div_param_" + actuator_name).style.display = "none";
      document.getElementById("div_act_" + actuator_name).style.display = "block";

    } else {
      document.getElementById("manual_" + actuator_name).style.fontWeight = 400;
      document.getElementById("automatic_" + actuator_name).style.fontWeight = 700;

      document.getElementById("div_param_" + actuator_name).style.display = "block";
      document.getElementById("div_act_" + actuator_name).style.display = "none";

    }
  }

  function buttonSetOpModeActuator(opmode, actuator) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/actuators/opmode/set/" + opmode, true);

    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        setOperationMode(opmode, actuator);
      }
    };
    xhttp.send();

  }



  function buttonSetActuator(state, actuator_name) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/actuators/status/set/" + actuator_name, true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        setFan(state, actuator_name);
      }
    };
    xhttp.send("value=" + state);
  }

  function updateActuatorsParam() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var array = this.responseText.split(" ");

        //index = |0: nebulizador umidade| |1: nebulizador temperatura|  |2: trocador de água variação| |3: ventilador temperatura|
        document.getElementById("minUmidity").placeholder = array[0];
        document.getElementById("maxTempNeb").placeholder = array[1];
        document.getElementById("deltaTemperature").placeholder = array[2];
        document.getElementById("maxTempFan").placeholder = array[3];
      }
    };
    xhttp.open("GET", "/actuators/parameter/getall", true);
    xhttp.send();
  }

  function updateSensors() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var array = this.responseText.split(" ");

        //index = |0: temperatura ambiente| |1: umidade ambiente relativa|  |2: temperatura da caixa| |3: temperatura do bebedouro|
        
        updateSensor(array[3], "nipple_temperature", "°C", "-127.00");
        updateSensor(array[2], "box_temperature", "°C", "-127.00");
        updateSensor(array[1], "climate_humidity", "%", "nan");
        updateSensor(array[0], "climate_temperature", "°C", "nan");
        
        document.getElementById("").placeholder = array[0];
        document.getElementById("maxTempNeb").placeholder = array[1];
        document.getElementById("deltaTemperature").placeholder = array[2];
        document.getElementById("maxTempFan").placeholder = array[3];
      }
    };
    xhttp.open("GET", "/sensors/getall", true);
    xhttp.send();
  }

  function updateActuatorsOpMode() { //atualizar o modo de operação dos atuadores
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var array = this.responseText.split(" ");

        //array indice = |0: nebulizador|  |1: trocador de água|   |2: ventilador|
        setOperationMode(array[0], "nebulizer");
        setOperationMode(array[1], "exchanger");
        setOperationMode(array[2], "fan");
      }
    };
    xhttp.open("GET", "/actuators/opmode/getall", true);
    xhttp.send();
  }

  function setActuator(state, actuator_name) {

    if (state == true) {
      
      if (actuator_name == "exchanger")
        document.getElementById("button_exchanger").innerHTML = "Interromper";
      else
        document.getElementById("button_" + name).innerHTML = "Desligar";
      
      document.getElementById("status_" + name).innerHTML = "Ligado";
      document.getElementById("status_" + name).style.color = "green";
    } else {
      document.getElementById("button_" + name).innerHTML = "Ligar";
      document.getElementById("status_" + name).innerHTML = "Desligado";
      document.getElementById("status_" + name).style.color = "red";
    }
  }

  function updateActuatorsState() {
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var array = this.responseText.split(" ");
        //array index = |0: trocador|  |1: ventilador|   |2: nebulizador|
        setActuator(array[0],"exchanger");
        setActuator(array[1],"fan");
        setActuator(array[2],"nebulizer");
      }
    };
    xhttp.open("GET", "/actuators/getall", true);
    xhttp.send();
  }


  function updateSensor(value, sensor_span, unit_measurement, text_error) {
    if (value == text_error) {
      document.getElementById(sensor_span).innerHTML = "Falha na leitura do sensor!";
      document.getElementById(sensor_span).style.color = "red";
    } else {
      document.getElementById(sensor_span).style.color = "black";
      document.getElementById(sensor_span).innerHTML = value + unit_measurement;
    }
  }

  //taxa de atualização de 5 segundos
  setInterval(function () {
    //atualizando o valor dos sensores
    updateSensors();
    
    //parametro de acionamento
    updateActuatorsParam();

    //status do modo de operação dos atuadores
    updateActuatorsOpMode();
  }, 5000);

  //taxa de atualização de 1 segundo
  setInterval(function () {
    //status dos atuadores
    updateActuatorsState();
  }, 1000);

</script>

</html>